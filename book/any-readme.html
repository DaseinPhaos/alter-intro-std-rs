<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Module `any`</title>

    <link rel="stylesheet" type="text/css" href="rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='macros-readme.html'><b>2.</b> Macros in std</a>
</li>
<li><a class='active' href='any-readme.html'><b>3.</b> `std::any`</a>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">Module `any`</h1>
    <blockquote>
<p>ref: <a href="https://doc.rust-lang.org/std/any/">https://doc.rust-lang.org/std/any/</a></p>
</blockquote>

<p>TODO:</p>

<ul>
<li>[ ] Fix backward reference: any reference to <code>std</code> components not mentioned beforehead should be marked and explained.</li>
<li>[ ] Structualize modules.</li>
</ul>

<p>This module defines the <code>Any</code> trait and the <code>TypeId</code> struct. Together they form minimal support for runtime reflection.</p>

<h1 id='typeid' class='section-header'><a href='#typeid'>TypeId</a></h1>
<p>A <code>TypeId</code> represents a globally unique identifier for a type. It&#39;s an opacue object, but does allow basic operations such as cloning, comparison, and formatting.</p>

<p>currently it is only available for <code>&#39;static</code> types.</p>

<p>The definition looks like (with some attributes and comments removed):</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#[<span class='ident'>derive</span>(<span class='ident'>Clone</span>, <span class='ident'>PartialEq</span>, <span class='ident'>Eq</span>, <span class='ident'>Debug</span>, <span class='ident'>Hash</span>)]</span>
<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>TypeId</span> {
    <span class='ident'>t</span>: <span class='ident'>u64</span>,
}

<span class='kw'>impl</span> <span class='ident'>TypeId</span> {
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>of</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='question-mark'>?</span><span class='ident'>Sized</span> <span class='op'>+</span> <span class='lifetime'>&#39;static</span><span class='op'>&gt;</span>() <span class='op'>-&gt;</span> <span class='ident'>TypeId</span> {
        <span class='ident'>TypeId</span> {
            <span class='ident'>t</span>: <span class='kw'>unsafe</span> { <span class='ident'>std</span>::<span class='ident'>intrinsics</span>::<span class='ident'>type_id</span>::<span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>() },
        }
    }
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%23%5Bderive(Clone%2C%20PartialEq%2C%20Eq%2C%20Debug%2C%20Hash)%5D%0Apub%20struct%20TypeId%20%7B%0A%20%20%20%20t%3A%20u64%2C%0A%7D%0A%0Aimpl%20TypeId%20%7B%0A%20%20%20%20pub%20fn%20of%3CT%3A%20%3FSized%20%2B%20'static%3E()%20-%3E%20TypeId%20%7B%0A%20%20%20%20%20%20%20%20TypeId%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20t%3A%20unsafe%20%7B%20std%3A%3Aintrinsics%3A%3Atype_id%3A%3A%3CT%3E()%20%7D%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%7D">Run</a></pre>

<p>Note the static method <code>of</code>. It should be used like this:</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>any</span>::<span class='ident'>TypeId</span>;

<span class='kw'>fn</span> <span class='ident'>is_string</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='question-mark'>?</span><span class='ident'>Sized</span> <span class='op'>+</span> <span class='lifetime'>&#39;static</span><span class='op'>&gt;</span>(<span class='ident'>_a</span>: <span class='kw-2'>&amp;</span><span class='ident'>T</span>) <span class='op'>-&gt;</span> <span class='ident'>bool</span> {
    <span class='ident'>TypeId</span>::<span class='ident'>of</span>::<span class='op'>&lt;</span><span class='ident'>String</span><span class='op'>&gt;</span>() <span class='op'>==</span> <span class='ident'>TypeId</span>::<span class='ident'>of</span>::<span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>()
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='macro'>assert_eq</span><span class='macro'>!</span>(<span class='ident'>is_string</span>(<span class='kw-2'>&amp;</span><span class='number'>0</span>), <span class='bool-val'>false</span>);
    <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>is_string</span>(<span class='kw-2'>&amp;</span><span class='string'>&quot;foo&quot;</span>.<span class='ident'>to_owned</span>()));
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=use%20std%3A%3Aany%3A%3ATypeId%3B%0A%0Afn%20is_string%3CT%3A%20%3FSized%20%2B%20'static%3E(_a%3A%20%26T)%20-%3E%20bool%20%7B%0A%20%20%20%20TypeId%3A%3Aof%3A%3A%3CString%3E()%20%3D%3D%20TypeId%3A%3Aof%3A%3A%3CT%3E()%0A%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20assert_eq!(is_string(%260)%2C%20false)%3B%0A%20%20%20%20assert!(is_string(%26%22foo%22.to_owned()))%3B%0A%7D%0A">Run</a></pre>

<h1 id='any' class='section-header'><a href='#any'>Any</a></h1>
<p>The <code>Any</code> trait, however, being implemented for any <code>&#39;static</code> types as follows:</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>impl</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='lifetime'>&#39;static</span> <span class='op'>+</span> <span class='question-mark'>?</span><span class='ident'>Sized</span><span class='op'>&gt;</span> <span class='ident'>Any</span> <span class='kw'>for</span> <span class='ident'>T</span> {
    <span class='kw'>fn</span> <span class='ident'>get_type_id</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>TypeId</span> {
        <span class='ident'>TypeId</span>::<span class='ident'>of</span>::<span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>()
    }
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Aimpl%3CT%3A%20'static%20%2B%20%3FSized%3E%20Any%20for%20T%20%7B%0A%20%20%20%20fn%20get_type_id(%26self)%20-%3E%20TypeId%20%7B%0A%20%20%20%20%20%20%20%20TypeId%3A%3Aof%3A%3A%3CT%3E()%0A%20%20%20%20%7D%0A%7D%0A%7D">Run</a></pre>

<p>is more powerful. When used statically it&#39;s nothing more than a object oriented wrapper for <code>TypeId</code>&#39;s <code>of</code> method, as its definition looks like nothing more than this (with attributes and comments removed):</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>pub</span> <span class='kw'>trait</span> <span class='ident'>Any</span>: <span class='lifetime'>&#39;static</span> {
    <span class='kw'>fn</span> <span class='ident'>get_type_id</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>TypeId</span>;
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Apub%20trait%20Any%3A%20'static%20%7B%0A%20%20%20%20fn%20get_type_id(%26self)%20-%3E%20TypeId%3B%0A%7D%0A%7D">Run</a></pre>

<p>Netherless, the method provided is currently marked as <code>unstable</code>(<a href="https://github.com/rust-lang/rust/issues/27745">#27745</a>).</p>

<p>Its true strength comes when used as a trait object. It has an <code>is&lt;T&gt;</code> method whcich would return true if the underlying object is of type <code>T</code>, and two <code>downcast</code>ing methods returning corresponding <code>Some</code>.</p>

<p>The general use case can be demonstrated as follow:
```rust
use std::any::Any;</p>

<p>fn is_string(a: &amp;Any) -&gt; bool {
    a.is::<String>()<br>
}</p>

<p>fn format_if_str_literal(a: &amp;Any) -&gt; String {
    if let Some(s) = a.downcast_ref::&lt;&amp;&#39;static str&gt;() {
        format!(&quot;It is a string literal with a length of ({}): {}&quot;, s.len(), s)
    } else {
        format!(&quot;Not a string literal...&quot;)
    }
}</p>

<p>fn main() {
    assert_eq!(format_if_str_literal(&amp;1.1), &quot;Not a string literal...&quot;);
    assert_eq!(format_if_str_literal(&amp;&quot;cookie monster&quot;), &quot;It is a string literal with a length of (14): cookie monster&quot;);</p>

<pre class='rust rust-example-rendered'>
<span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>is_string</span>(<span class='kw-2'>&amp;</span><span class='string'>&quot;Foo&quot;</span>.<span class='ident'>to_string</span>()));
<span class='macro'>assert</span><span class='macro'>!</span>(<span class='op'>!</span><span class='ident'>is_string</span>(<span class='kw-2'>&amp;</span><span class='string'>&quot;Foo&quot;</span>));<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Aassert!(is_string(%26%22Foo%22.to_string()))%3B%0Aassert!(!is_string(%26%22Foo%22))%3B%0A%7D">Run</a></pre>

<p>}
```</p>

<p>The actual implementation looks like the following:</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>impl</span> <span class='ident'>Any</span> {
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>is</span> <span class='op'>&lt;</span><span class='ident'>T</span>: <span class='ident'>Any</span><span class='op'>&gt;</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>bool</span> {
        <span class='kw'>let</span> <span class='ident'>t</span> <span class='op'>=</span> <span class='ident'>TypeId</span>::<span class='ident'>of</span>::<span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>();

        <span class='kw'>let</span> <span class='ident'>boxed</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>get_type_id</span>();

        <span class='ident'>t</span> <span class='op'>==</span> <span class='ident'>boxed</span>
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>downcast_ref</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='ident'>AnyM</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='kw-2'>&amp;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
        <span class='kw'>if</span> <span class='self'>self</span>.<span class='ident'>is</span>::<span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>() {
            <span class='kw'>unsafe</span> {
                <span class='prelude-val'>Some</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>*</span>(<span class='self'>self</span> <span class='kw'>as</span> <span class='kw-2'>*</span><span class='kw'>const</span> <span class='ident'>Any</span> <span class='kw'>as</span> <span class='kw-2'>*</span><span class='kw'>const</span> <span class='ident'>T</span>))
            }
        } <span class='kw'>else</span> {
            <span class='prelude-val'>None</span>
        }
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>downcast_mut</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='ident'>Any</span><span class='op'>&gt;</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>T</span><span class='op'>&gt;</span> {
        <span class='kw'>if</span> <span class='self'>self</span>.<span class='ident'>is</span>::<span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>() {
            <span class='kw'>unsafe</span> {
                <span class='prelude-val'>Some</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='kw-2'>*</span>(<span class='self'>self</span> <span class='kw'>as</span> <span class='kw-2'>*</span><span class='kw-2'>mut</span> <span class='ident'>Any</span> <span class='kw'>as</span> <span class='kw-2'>*</span><span class='kw-2'>mut</span> <span class='ident'>T</span>))
            }
        } <span class='kw'>else</span> {
            <span class='prelude-val'>None</span>
        }
    }
}

<span class='kw'>impl</span> <span class='ident'>Any</span><span class='op'>+</span><span class='ident'>Send</span> {
    <span class='comment'>// Same as above..</span>
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Aimpl%20Any%20%7B%0A%20%20%20%20pub%20fn%20is%20%3CT%3A%20Any%3E(%26self)%20-%3E%20bool%20%7B%0A%20%20%20%20%20%20%20%20let%20t%20%3D%20TypeId%3A%3Aof%3A%3A%3CT%3E()%3B%0A%0A%20%20%20%20%20%20%20%20let%20boxed%20%3D%20self.get_type_id()%3B%0A%0A%20%20%20%20%20%20%20%20t%20%3D%3D%20boxed%0A%20%20%20%20%7D%0A%0A%20%20%20%20pub%20fn%20downcast_ref%3CT%3A%20AnyM(%26self)%20-%3E%20Option%3C%26T%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20self.is%3A%3A%3CT%3E()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20unsafe%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Some(%26*(self%20as%20*const%20Any%20as%20*const%20T))%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20None%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20pub%20fn%20downcast_mut%3CT%3A%20Any%3E(%26mut%20self)%20-%3E%20Option%3C%26mut%20T%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20self.is%3A%3A%3CT%3E()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20unsafe%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Some(%26mut%20*(self%20as%20*mut%20Any%20as%20*mut%20T))%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20None%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Aimpl%20Any%2BSend%20%7B%0A%20%20%20%20%2F%2F%20Same%20as%20above..%0A%7D%0A%7D">Run</a></pre>

<p>Note the direct use of <code>impl</code> on trait objects. This is valid code, but The Book has failed to mention it(not in my memory).</p>

<p>Also note that for convinience, these methods are also implemented for trait object <code>Any+Send</code> (with the implementation simply forwarding to <code>Any</code>).</p>

<p>Additionally, <code>std::fmt::Debug</code> is implemented for <code>Any</code> as well as <code>Any+Send</code>.</p>

<p>Another thing to notice is that <code>std::fmt::Debug</code> is implemented for <code>Any</code>, and of course for <code>Any+Send</code>.</p>

    <script src='rustbook.js'></script>
</div></div>


</body>
</html>